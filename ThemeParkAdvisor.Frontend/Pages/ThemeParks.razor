@page "/themeparks"
@using System.Net.Http.Json
@using ThemeParkAdvisor.Shared
@inject HttpClient Http

<h3>Zábavní Parky</h3>

<EditForm Model="@this" OnValidSubmit="SendRequest">
    <DataAnnotationsValidator />
    <Component />

    <!-- Favorite theme parks dropdown  -->
    <div class="mb-3">
        <label>Oblíbený zábavní park:</label>
        <InputSelect @bind-Value="FavoriteThemeParkId" class="form-control">
            <option value="">-- Vyberte park --</option>
            @if (themeParkNames != null)
            {
                @foreach (var park in themeParkNames)
                {
                    <option value="@park.ThemeParkId">@park.Name</option>
                }
            }
        </InputSelect>
    </div>

    <!-- Theme Parks, user does not want to visit -->
    <div class="mb-3">
        <label>Parky, které nechci navštívit:</label>
        <div class="d-flex gap-2">
            <InputSelect @bind-Value="SelectedNotToVisitId" class="form-select w-100">
                <option value="">-- Vyberte park k přidání --</option>
                @if (themeParkNames != null)
                {
					var ThemeParksNotToVisitIds = ThemeParksNotToVisit.Select(t => t.Item1).ToList();
                    @foreach (var park in themeParkNames
                                    .Where(p => ThemeParksNotToVisitIds.Contains(p.ThemeParkId) == false))
                    {
                        <option value="@park.ThemeParkId">@park.Name</option>
                    }
                }
            </InputSelect>
            <button type="button"
                    class="btn btn-outline-secondary"
                    @onclick="AddNotToVisit"
                    disabled="@(SelectedNotToVisitId is null)">
                Přidat
            </button>
        </div>

        @if (ThemeParksNotToVisit.Any())
        {
            <div class="mt-2 d-flex flex-wrap gap-2">
                @foreach (var park in ThemeParksNotToVisit)
                {
                    var name = park.Item2;
                    <span class="badge bg-light text-dark">
                        @name
                        <button type="button"
                                class="btn btn-sm btn-light ms-2 py-0 px-1"
                                title="Odebrat"
                                @onclick="() => RemoveNotToVisit(park.Item1)">
                            ×
                        </button>
                    </span>
                }
            </div>
        }
    </div>

    <!-- Countries dropdown -->
    <div class="mb-3">
        <label>Země:</label>
        <InputSelect @bind-Value="CountryId"
                     @bind-Value:after="OnCountryChanged"
                     class="form-control">
            <option value="">-- Vyberte zemi --</option>
            @if (countries != null)
            {
                @foreach (var c in countries.OrderBy(c => c.Name))
                {
                    <option value="@c.CountryId">@c.Name</option>
                }
            }
        </InputSelect>
    </div>

    <!-- Regions dropdown -->
    <div class="mb-3">
        <label>Region:</label>
        <InputSelect @bind-Value="RegionId"
                     @bind-Value:after="OnRegionChanged"
                     class="form-control"
                     disabled="@(CountryId is null)">
            <option value="">-- Vyberte region --</option>
            @if (regions != null)
            {
                @foreach (var r in regions.OrderBy(r => r.Name))
                {
                    <option value="@r.RegionId">@r.Name</option>
                }
            }
        </InputSelect>
    </div>

    <!-- ¨Cities dropdown -->
    <div class="mb-3">
        <label>Město:</label>
        <InputSelect @bind-Value="CityId"
                     @bind-Value:after="OnCityChanged"
                     class="form-control"
                     disabled="@(CountryId is null)">
            <option value="">-- Vyberte město --</option>
            @if (cities != null)
            {
                @foreach (var m in cities.OrderBy(m => m.Name))
                {
                    <option value="@m.CityId">@m.Name</option>
                }
            }
        </InputSelect>
    </div>


    <div class="mb-3 row">
        <div class="col">
            <label>Latitude:</label>
            <InputNumber @bind-Value="Latitude" class="form-control" />
        </div>
        <div class="col">
            <label>Longitude:</label>
            <InputNumber @bind-Value="Longitude" class="form-control" />
        </div>
    </div>

    <div class="mb-3">
        <label>Level adrenalinu (0–10):</label>
        <InputNumber @bind-Value="AdrenalineLevel" class="form-control" />
        @if (AdrenalineLevel is < 0 or > 10)
        {
            <div class="text-danger">Hodnota musí být mezi 0 a 10.</div>
        }
    </div>

    <div class="mb-3">
        <label>Minimální počet atrakcí:</label>
        <InputNumber @bind-Value="MinAttractionsCount" class="form-control"/>
    </div>

    <hr />

    <h4>Cestovatelé</h4>
    <button type="button" class="btn btn-success mb-3" @onclick="AddTraveler">Přidat dalšího</button>
   
    @foreach (var traveler in Travelers)
    {
        <div @key="traveler.Id" class="mb-2">
            <InputNumber @bind-Value="traveler.Age" class="form-control d-inline-block w-auto" placeholder="Věk" />
            <button type="button" class="btn btn-danger btn-sm ms-2" @onclick="() => RemoveTraveler(traveler.Id)">Smazat</button>
        </div>
    }

    <hr class="my-4" />

    <div class="mb-3">
        <label>Počet zábavních parků k zobrazení:</label>
        <InputNumber @bind-Value="WantedThemeParksCount" class="form-control" placeholder="5" />
    </div>

    <button type="submit" class="btn btn-primary">Odeslat požadavek</button>
</EditForm>

<!-- Výpis výsledků -->
@if (parks != null && parks.Any())
{
    <h4 class="mt-4">Doporučené parky:</h4>
    <div class="row">
        @foreach (var park in parks)
        {
            <div class="col-md-4 mb-3">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">@park.Name</h5>
                        <h6 class="card-subtitle mb-2 text-muted">@park.CityName, @park.CountryName</h6>
                        <p class="card-text">
                            <strong>Velikost:</strong> @park.Size <br />
                            <strong>Atrakce:</strong> @park.AttractionCount <br />
                            <strong>Horských drah:</strong> @park.RollerCoasterCount <br />
                            <strong>Skóre:</strong> @park.Score
                        </p>
                    </div>
                    <div class="card-footer text-muted">
                        GPS: @park.Latitude, @park.Longitude
                    </div>
                </div>
            </div>
        }
    </div>
}
else if (responseText != null)
{
    <div class="alert alert-info mt-4">@responseText</div>
}

@code {
    public int? FavoriteThemeParkId { get; set; }
    public int? SelectedNotToVisitId { get; set; }
    public List<Tuple<int,string>> ThemeParksNotToVisit { get; set; } = new();

    public int? CountryId { get; set; }
    public int? RegionId { get; set; }
    public int? CityId { get; set; }

    private List<CountryNameDto>? countries;
    private List<RegionNameDto>? regions;
    private List<CityNameDto>? cities;

    public int? AdrenalineLevel { get; set; }
    public int? WantedThemeParksCount { get; set; }
    public int? MinAttractionsCount { get; set; }
    public double? Latitude { get; set; }
    public double? Longitude { get; set; }

    public class Traveler
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public int? Age { get; set; }
    }

    public List<Traveler> Travelers { get; set; } = new();

    private string? responseText;
    private List<ThemeParkRecommendationDto>? parks;
    private List<ThemeParkNameDto>? themeParkNames;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // načti všechny země hned na začátku
            var response = await Http.PostAsJsonAsync("api/Countries/countries", new CountryFilterDto());
            countries = await response.Content.ReadFromJsonAsync<List<CountryNameDto>>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chyba při načítání seznamu zemí: {ex.Message}");
        }

        try
        {
            var themeParkResponse = await Http.PostAsJsonAsync("api/ThemeParks/names", new ThemeParkNameFilterDto(CountryId: null, RegionId: null, CityId: null));
            themeParkNames = await themeParkResponse.Content.ReadFromJsonAsync<List<ThemeParkNameDto>>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chyba při načítání seznamu parků: {ex.Message}");
        }
    }

    private async Task OnCountryChanged()
    {
        // CountryId už je nastaveno bindingem
        RegionId = null;
        CityId = null;

        if (CountryId is int cid)
        {
            var regionResponse = await Http.PostAsJsonAsync("api/Regions/regions", new RegionFilterDto(CountryId: cid));
            regions = await regionResponse.Content.ReadFromJsonAsync<List<RegionNameDto>>();

            var cityResponse = await Http.PostAsJsonAsync("api/Cities/cities", new CityFilterDto(CountryId: cid));
            cities = await cityResponse.Content.ReadFromJsonAsync<List<CityNameDto>>();

            var themeParkResponse = await Http.PostAsJsonAsync("api/ThemeParks/names", new ThemeParkNameFilterDto(CountryId: cid, RegionId: null, CityId: null));
            themeParkNames = await themeParkResponse.Content.ReadFromJsonAsync<List<ThemeParkNameDto>>();
        }
        else
        {
            var themeParkResponse = await Http.PostAsJsonAsync("api/ThemeParks/names", new ThemeParkNameFilterDto(CountryId: null, RegionId: null, CityId: null));
            themeParkNames = await themeParkResponse.Content.ReadFromJsonAsync<List<ThemeParkNameDto>>();

            regions = null;
            cities = null;
        }
    }

    private async Task OnRegionChanged()
    {
        CityId = null;

        if (RegionId is int rid)
        {
            var countryResponse = await Http.PostAsJsonAsync("api/Countries/countries", new CountryFilterDto(RegionId: rid));
            var possibleCountries = await countryResponse.Content.ReadFromJsonAsync<List<CountryNameDto>>();
            if (possibleCountries?.Any() == true)
                CountryId = possibleCountries.First().CountryId;

            var cityResponse = await Http.PostAsJsonAsync("api/Cities/cities", new CityFilterDto(RegionId: rid));
            cities = await cityResponse.Content.ReadFromJsonAsync<List<CityNameDto>>();
        }
        else if (CountryId is int cid)
        {
            var cityResponse = await Http.PostAsJsonAsync("api/Cities/cities", new CityFilterDto(CountryId: cid));
            cities = await cityResponse.Content.ReadFromJsonAsync<List<CityNameDto>>();
        }
    }

    private async Task OnCityChanged()
    {
        if (CityId is int cityId)
        {
            var regionResponse = await Http.PostAsJsonAsync("api/Regions/regions", new RegionFilterDto(CityId: cityId));
            var possibleRegions = await regionResponse.Content.ReadFromJsonAsync<List<RegionNameDto>>();
            if (possibleRegions?.Any() == true)
                RegionId = possibleRegions.First().RegionId;

            var countryResponse = await Http.PostAsJsonAsync("api/Countries/countries", new CountryFilterDto(CityId: cityId));
            var possibleCountries = await countryResponse.Content.ReadFromJsonAsync<List<CountryNameDto>>();
            if (possibleCountries?.Any() == true)
                CountryId = possibleCountries.First().CountryId;
        }
    }



    private void AddTraveler() => Travelers.Add(new Traveler());

    private void RemoveTraveler(Guid id)
    {
        var traveler = Travelers.FirstOrDefault(t => t.Id == id);
        if (traveler != null)
            Travelers.Remove(traveler);
    }

    private void AddNotToVisit()
    {
        if (SelectedNotToVisitId is int id)
        {
			Tuple<int, string> parkTuple = new(id, themeParkNames?.FirstOrDefault(p => p.ThemeParkId == id)?.Name ?? $"ID {id}");
            if (!ThemeParksNotToVisit.Contains(parkTuple))
            {
                ThemeParksNotToVisit.Add(parkTuple);
            }
            
            SelectedNotToVisitId = null;
        }
    }

    private void RemoveNotToVisit(int id)
    {
        Tuple<int, string> parkTuple = ThemeParksNotToVisit?.FirstOrDefault(p => p.Item1 == id);
        ThemeParksNotToVisit.Remove(parkTuple);
    }

    private async Task GetCountriesAsync()
    {
        var countryFilter = new CountryFilterDto
        {
            RegionId = null,
            CityId = null
		};

        var response = await Http.PostAsJsonAsync("api/Countries/countries", countryFilter);
        response.EnsureSuccessStatusCode();

        countries = await response.Content.ReadFromJsonAsync<List<CountryNameDto>>();
        responseText = countries == null || !countries.Any()
            ? "Žádné výsledky."
            : null;
    }

    private async Task SendRequest()
    {
        if (AdrenalineLevel is < 0 or > 10)
        {
            responseText = "Chyba: AdrenalineLevel musí být mezi 0 a 10.";
            parks = null;
            return;
        }

		var ThemeParksNotToVisitIds = ThemeParksNotToVisit.Select(t => t.Item1).ToList();

        var dto = new ThemeParkPreferencesDto(
            FavoriteThemeParkId,
            ThemeParksNotToVisitIds.Any() ? ThemeParksNotToVisitIds.ToArray() : null,
            Travelers.Where(t => t.Age.HasValue).Select(t => t.Age!.Value).ToArray(),
            CountryId,
            RegionId,
            CityId,
            AdrenalineLevel,
            Latitude,
            Longitude,
            WantedThemeParksCount,
            MinAttractionsCount
        );

        try
        {
            var response = await Http.PostAsJsonAsync("api/ThemeParks/recommendations", dto);
            response.EnsureSuccessStatusCode();

            // Deserializace přímo na seznam DTO
            parks = await response.Content.ReadFromJsonAsync<List<ThemeParkRecommendationDto>>();
            responseText = parks == null || !parks.Any()
                ? "Žádné výsledky."
                : null;
        }
        catch (Exception ex)
        {
            responseText = $"Chyba: {ex.Message}";
            parks = null;
        }
    }
}